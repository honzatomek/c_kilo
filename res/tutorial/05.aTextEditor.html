<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>5. A text editor | Build Your Own Text Editor</title>
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <header class="bar">
      <nav>
        <a href='04.aTextViewer.html'>&larr; prev</a>
        <a href="index.html">contents</a>
        <a href='06.search.html'>next &rarr;</a>
      </nav>
    </header>
    <div id="container">
      <h1 id="a-text-editor">A text editor</h1>
<h2 id="insert-ordinary-characters"><a href="#insert-ordinary-characters">Insert ordinary characters</a></h2>

<p>Let&rsquo;s begin by writing a function that inserts a single character into an
<code>erow</code>, at a given position.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/row-insert-char/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 101</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/row-insert-char">row-insert-char</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line"><span class="cm">/*** row operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="n">at</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span></ins><ins class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span></ins><ins class="line">  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></ins><ins class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span></ins><ins class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span></ins><ins class="line">  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p><code>memmove()</code> comes from <code>&lt;string.h&gt;</code>. It is like <code>memcpy()</code>, but is safe to use
when the source and destination arrays overlap.</p>

<p>First we validate <code>at</code>, which is the index we want to insert the character
into. Notice that <code>at</code> is allowed to go one character past the end of the
string, in which case the character should be inserted at the end of the
string.</p>

<p>Then we allocate one more byte for the <code>chars</code> of the <code>erow</code> (we add <code>2</code>
because we also have to make room for the null byte), and use <code>memmove()</code> to
make room for the new character. We increment the <code>size</code> of the <code>chars</code> array,
and then actually assign the character to its position in the array. Finally,
we call <code>editorUpdateRow()</code> so that the <code>render</code> and <code>rsize</code> fields get updated
with the new row content.</p>

<p>Now we&rsquo;ll create a new section called <code>/*** editor operations ***/</code>. This
section will contain functions that we&rsquo;ll call from <code>editorProcessKeypress()</code>
when we&rsquo;re mapping keypresses to various text editing operations. We&rsquo;ll add a
function to this section called <code>editorInsertChar()</code> which will take a
character and use <code>editorRowInsertChar()</code> to insert that character into the
position that the cursor is at.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/editor-insert-char/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 102</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/editor-insert-char">editor-insert-char</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line"><span class="cm">/*** row operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="cm">/*** editor operations ***/</span></ins><ins class="line"></ins><ins class="line"><span class="kt">void</span> <span class="nf">editorInsertChar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">editorAppendRow</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></ins><ins class="line">  <span class="p">}</span></ins><ins class="line">  <span class="n">editorRowInsertChar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">],</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span></ins><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>If <code>E.cy == E.numrows</code>, then the cursor is on the tilde line after the end of
the file, so we need to append a new row to the file before inserting a
character there. After inserting a character, we move the cursor forward so
that the next character the user inserts will go after the character just
inserted.</p>

<p>Notice that <code>editorInsertChar()</code> doesn&rsquo;t have to worry about the details of
modifying an <code>erow</code>, and <code>editorRowInsertChar()</code> doesn&rsquo;t have to worry about
where the cursor is. That is the difference between functions in the
<code>/*** editor operations ***/</code> section and functions in the
<code>/*** row operations ***/</code> section.</p>

<p>Let&rsquo;s call <code>editorInsertChar()</code> in the <code>default:</code> case of the <code>switch</code>
statement in <code>editorProcessKeypress()</code>. This will allow any keypress that isn&rsquo;t
mapped to another editor function to be inserted directly into the text being
edited.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/key-insert-char/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 103</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/key-insert-char">key-insert-char</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><div class="line"></div><div class="line">  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></div><div class="line">      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span></div><div class="line">      <span class="p">{</span></div><div class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></div><div class="line">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">        <span class="p">}</span></div><div class="line"></div><div class="line">        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span></div><div class="line">        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span></div><div class="line">          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span></div><div class="line">      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><ins class="line">    <span class="nl">default:</span></ins><ins class="line">      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></ins><ins class="line">      <span class="k">break</span><span class="p">;</span></ins><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>We&rsquo;ve now officially upgraded our text viewer to a text editor.</p>
<h2 id="prevent-inserting-special-characters"><a href="#prevent-inserting-special-characters">Prevent inserting special characters</a></h2>

<p>Currently, if you press keys like <kbd>Backspace</kbd> or <kbd>Enter</kbd>,
those characters will be inserted directly into the text, which we certainly
don&rsquo;t want. Let&rsquo;s handle a bunch of these special keys in
<code>editorProcessKeypress()</code>, so that they don&rsquo;t fall through to the <code>default</code>
case of calling <code>editorInsertChar()</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/block-special-chars/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 104</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/block-special-chars">block-special-chars</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line"><span class="cm">/*** defines ***/</span></div><div class="line"></div><div class="line"><span class="cp">#define KILO_VERSION "0.0.1"</span></div><div class="line"><span class="cp">#define KILO_TAB_STOP 8</span></div><div class="line"></div><div class="line"><span class="cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span></div><div class="line"></div><div class="line"><span class="k">enum</span> <span class="n">editorKey</span> <span class="p">{</span></div><ins class="line">  <span class="n">BACKSPACE</span> <span class="o">=</span> <span class="mi">127</span><span class="p">,</span></ins><div class="line">  <span class="n">ARROW_LEFT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span></div><div class="line">  <span class="n">ARROW_RIGHT</span><span class="p">,</span></div><div class="line">  <span class="n">ARROW_UP</span><span class="p">,</span></div><div class="line">  <span class="n">ARROW_DOWN</span><span class="p">,</span></div><div class="line">  <span class="n">DEL_KEY</span><span class="p">,</span></div><div class="line">  <span class="n">HOME_KEY</span><span class="p">,</span></div><div class="line">  <span class="n">END_KEY</span><span class="p">,</span></div><div class="line">  <span class="n">PAGE_UP</span><span class="p">,</span></div><div class="line">  <span class="n">PAGE_DOWN</span></div><div class="line"><span class="p">};</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><div class="line"></div><div class="line">  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><ins class="line">    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span></ins><ins class="line">      <span class="cm">/* TODO */</span></ins><ins class="line">      <span class="k">break</span><span class="p">;</span></ins><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></div><div class="line">      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><ins class="line">    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span></ins><ins class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span></ins><ins class="line">    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span></ins><ins class="line">      <span class="cm">/* TODO */</span></ins><ins class="line">      <span class="k">break</span><span class="p">;</span></ins><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span></div><div class="line">      <span class="p">{</span></div><div class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></div><div class="line">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">        <span class="p">}</span></div><div class="line"></div><div class="line">        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span></div><div class="line">        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span></div><div class="line">          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span></div><div class="line">      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><ins class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span></ins><ins class="line">    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span></ins><ins class="line">      <span class="k">break</span><span class="p">;</span></ins><div class="line"></div><div class="line">    <span class="nl">default:</span></div><div class="line">      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p><kbd>Backspace</kbd> doesn&rsquo;t have a human-readable backslash-escape
representation in C (like <code>\n</code>, <code>\r</code>, and so on), so we make it part of the
<code>editorKey</code> enum and assign it its ASCII value of <code>127</code>.</p>

<p>In <code>editorProcessKeypress()</code>, the first new key we add to the <code>switch</code>
statement is <code>&#39;\r&#39;</code>, which is the <kbd>Enter</kbd> key. For now we want to
ignore it, but obviously we&rsquo;ll be making it do something later, so we mark it
with a <code>TODO</code> comment.</p>

<p>We handle <kbd>Backspace</kbd> and <kbd>Delete</kbd> in a similar way, marking
them with a <code>TODO</code>. We also handle the <kbd>Ctrl-H</kbd> key combination, which
sends the control code <code>8</code>, which is originally what the <kbd>Backspace</kbd>
character would send back in the day. If you look at the
<a href="http://www.asciitable.com/">ASCII table</a>, you&rsquo;ll see that ASCII code <code>8</code> is
named <code>BS</code> for &ldquo;backspace&rdquo;, and ASCII code <code>127</code> is named <code>DEL</code> for &ldquo;delete&rdquo;.
But for whatever reason, in modern computers the <kbd>Backspace</kbd> key is
mapped to <code>127</code> and the <kbd>Delete</kbd> key is mapped to the escape sequence
<code>&lt;esc&gt;[3~</code>, as we saw at the end of
<a href="03.rawInputAndOutput.html#the-delete-key">chapter 3</a>.</p>

<p>Lastly, we handle <kbd>Ctrl-L</kbd> and <kbd>Escape</kbd> by not doing anything
when those keys are pressed. <kbd>Ctrl-L</kbd> is traditionally used to refresh
the screen in terminal programs. In our text editor, the screen refreshes after
<em>any</em> keypress, so we don&rsquo;t have to do anything else to implement that feature.
We ignore the <kbd>Escape</kbd> key because there are many key escape sequences
that we aren&rsquo;t handling (such as the <kbd>F1</kbd>&ndash;<kbd>F12</kbd> keys),
and the way we wrote <code>editorReadKey()</code>, pressing those keys will be equivalent
to pressing the <kbd>Escape</kbd> key. We don&rsquo;t want the user to unwittingly
insert the escape character <code>27</code> into their text, so we ignore those
keypresses.</p>
<h2 id="save-to-disk"><a href="#save-to-disk">Save to disk</a></h2>

<p>Now that we&rsquo;ve finally made text editable, let&rsquo;s implement saving to disk.
First we&rsquo;ll write a function that converts our array of <code>erow</code> structs into a
single string that is ready to be written out to a file.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/rows-to-string/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 105</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/rows-to-string">rows-to-string</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><ins class="line"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="kt">int</span> <span class="n">totlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></ins><ins class="line">  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span></ins><ins class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span></ins><ins class="line">    <span class="n">totlen</span> <span class="o">+=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span></ins><ins class="line">  <span class="o">*</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">totlen</span><span class="p">;</span></ins><ins class="line"></ins><ins class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">totlen</span><span class="p">);</span></ins><ins class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span></ins><ins class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span><span class="p">);</span></ins><ins class="line">    <span class="n">p</span> <span class="o">+=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></ins><ins class="line">    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span></ins><ins class="line">    <span class="n">p</span><span class="o">++</span><span class="p">;</span></ins><ins class="line">  <span class="p">}</span></ins><ins class="line"></ins><ins class="line">  <span class="k">return</span> <span class="n">buf</span><span class="p">;</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>First we add up the lengths of each row of text, adding <code>1</code> to each one for the
newline character we&rsquo;ll add to the end of each line. We save the total length
into <code>buflen</code>, to tell the caller how long the string is.</p>

<p>Then, after allocating the required memory, we loop through the rows, and
<code>memcpy()</code> the contents of each row to the end of the buffer, appending a
newline character after each row.</p>

<p>We return <code>buf</code>, expecting the caller to <code>free()</code> the memory.</p>

<p>Now we&rsquo;ll implement the <code>editorSave()</code> function, which will actually write the
string returned by <code>editorRowsToString()</code> to disk.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/save/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 106</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/save">save</a></div>
</div><pre class="highlight"><code><div class="line"><span class="cm">/*** includes ***/</span></div><div class="line"></div><div class="line"><span class="cp">#define _DEFAULT_SOURCE</span></div><div class="line"><span class="cp">#define _BSD_SOURCE</span></div><div class="line"><span class="cp">#define _GNU_SOURCE</span></div><div class="line"></div><div class="line"><span class="cp">#include &lt;ctype.h&gt;</span></div><div class="line"><span class="cp">#include &lt;errno.h&gt;</span></div><ins class="line"><span class="cp">#include &lt;fcntl.h&gt;</span></ins><div class="line"><span class="cp">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="cp">#include &lt;stdarg.h&gt;</span></div><div class="line"><span class="cp">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="cp">#include &lt;string.h&gt;</span></div><div class="line"><span class="cp">#include &lt;sys/ioctl.h&gt;</span></div><div class="line"><span class="cp">#include &lt;sys/types.h&gt;</span></div><div class="line"><span class="cp">#include &lt;termios.h&gt;</span></div><div class="line"><span class="cp">#include &lt;time.h&gt;</span></div><div class="line"><span class="cp">#include &lt;unistd.h&gt;</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></ins><ins class="line"></ins><ins class="line">  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span></ins><ins class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span></ins><ins class="line"></ins><ins class="line">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span></ins><ins class="line">  <span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></ins><ins class="line">  <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></ins><ins class="line">  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></ins><ins class="line">  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p><code>open()</code>, <code>O_RDWR</code>, and <code>O_CREAT</code> come from <code>&lt;fcntl.h&gt;</code>. <code>ftruncate()</code> and
<code>close()</code> come from <code>&lt;unistd.h&gt;</code>.</p>

<p>If it&rsquo;s a new file, then <code>E.filename</code> will be <code>NULL</code>, and we won&rsquo;t know where
to save the file, so we just <code>return</code> without doing anything for now. Later,
we&rsquo;ll figure out how to prompt the user for a filename.</p>

<p>Otherwise, we call <code>editorRowsToString()</code>, and <code>write()</code> the string to the path
in <code>E.filename</code>. We tell <code>open()</code> we want to create a new file if it
doesn&rsquo;t already exist (<code>O_CREAT</code>), and we want to open it for reading and
writing (<code>O_RDWR</code>). Because we used the <code>O_CREAT</code> flag, we have to pass an
extra argument containing the mode (the permissions) the new file should have.
<code>0644</code> is the standard permissions you usually want for text files. It gives
the owner of the file permission to read and write the file, and everyone else
only gets permission to read the file.</p>

<p><code>ftruncate()</code> sets the file&rsquo;s size to the specified length. If the file is
larger than that, it will cut off any data at the end of the file to make it
that length. If the file is shorter, it will add <code>0</code> bytes at the end to make
it that length.</p>

<p>The normal way to overwrite a file is to pass the <code>O_TRUNC</code> flag to <code>open()</code>,
which truncates the file completely, making it an empty file, before writing
the new data into it. By truncating the file ourselves to the same length as
the data we are planning to write into it, we are making the whole overwriting
operation a little bit safer in case the <code>ftruncate()</code> call succeeds but the
<code>write()</code> call fails. In that case, the file would still contain most of the
data it had before. But if the file was truncated completely by the <code>open()</code>
call and then the <code>write()</code> failed, you&rsquo;d end up with all of your data lost.</p>

<p>More advanced editors will write to a new, temporary file, and then rename that
file to the actual file the user wants to overwrite, and they&rsquo;ll carefully
check for errors through the whole process.</p>

<p>Anyways, all we have to do now is map a key to <code>editorSave()</code>, so let&rsquo;s do it!
We&rsquo;ll use <kbd>Ctrl-S</kbd>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/ctrl-s/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 107</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/ctrl-s">ctrl-s</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><div class="line"></div><div class="line">  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span></div><div class="line">      <span class="cm">/* TODO */</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></div><div class="line">      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><ins class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span></ins><ins class="line">      <span class="n">editorSave</span><span class="p">();</span></ins><ins class="line">      <span class="k">break</span><span class="p">;</span></ins><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span></div><div class="line">      <span class="cm">/* TODO */</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span></div><div class="line">      <span class="p">{</span></div><div class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></div><div class="line">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">        <span class="p">}</span></div><div class="line"></div><div class="line">        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span></div><div class="line">        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span></div><div class="line">          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span></div><div class="line">      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="nl">default:</span></div><div class="line">      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>You should be able to open a file in the editor, insert some characters, press
<kbd>Ctrl-S</kbd>, and reopen the file to confirm that the changes you made
were saved.</p>

<p>Let&rsquo;s add error handling to <code>editorSave()</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/save-errors/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 108</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/save-errors">save-errors</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span></div><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></ins><div class="line">        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><ins class="line">        <span class="k">return</span><span class="p">;</span></ins><ins class="line">      <span class="p">}</span></ins><ins class="line">    <span class="p">}</span></ins><ins class="line">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></ins><ins class="line">  <span class="p">}</span></ins><ins class="line"></ins><ins class="line">  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></ins><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p><code>open()</code> and <code>ftruncate()</code> both return <code>-1</code> on error. We expect <code>write()</code> to
return the number of bytes we told it to write. Whether or not an error
occurred, we ensure that the file is closed and the memory that <code>buf</code> points to
is freed.</p>

<p>Let&rsquo;s use <code>editorSetStatusMessage()</code> to notify the user whether the save
succeeded or not. While we&rsquo;re at it, we&rsquo;ll add the <kbd>Ctrl-S</kbd> key
binding to the help message that&rsquo;s set in <code>main()</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/save-status-message/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 109</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/save-status-message">save-status-message</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><ins class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></ins><div class="line">        <span class="k">return</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">    <span class="p">}</span></div><div class="line">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><ins class="line">  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span></ins><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line"><span class="cm">/*** init ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span></div><div class="line">  <span class="n">enableRawMode</span><span class="p">();</span></div><div class="line">  <span class="n">initEditor</span><span class="p">();</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">editorOpen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><ins class="line">  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"HELP: Ctrl-S = save | Ctrl-Q = quit"</span><span class="p">);</span></ins><div class="line"></div><div class="line">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">editorRefreshScreen</span><span class="p">();</span></div><div class="line">    <span class="n">editorProcessKeypress</span><span class="p">();</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c0">♏&#xFE0E; doesn’t compile</div>
</div>
</div>


<p><code>strerror()</code> comes from <code>&lt;string.h&gt;</code>.</p>

<p><code>strerror()</code> is like <code>perror()</code> (which we use in <code>die()</code>), but it takes the
<code>errno</code> value as an argument and returns the human-readable string for that
error code, so that we can make the error a part of the status message we
display to the user.</p>

<p>The above code doesn&rsquo;t actually compile, because we are trying to call
<code>editorSetStatusMessage()</code> before it is defined in the file. You can&rsquo;t do that
in C, because C was made to be a language that can be compiled in a <a href="https://en.wikipedia.org/wiki/One-pass_compiler">single
pass</a>, meaning it should be
possible to compile each part of a program without knowing what comes later in
the program.</p>

<p>When we call a function in C, the compiler needs to know the arguments and
return value of that function. We can tell the compiler this information about
<code>editorSetStatusMessage()</code> by declaring a function prototype for it near the
top of the file. This allows us to call the function before it is defined.
We&rsquo;ll add a new <code>/*** prototypes ***/</code> section and put the declaration under
it.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/prototypes/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 110</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/prototypes">prototypes</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line"><span class="cm">/*** data ***/</span></div><div class="line"></div><div class="line folded"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">erow</span> <span class="p">{</span> &hellip; <span class="p">}</span> <span class="n">erow</span><span class="p">;</span></div><div class="line"></div><div class="line folded"><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span> &hellip; <span class="p">};</span></div><div class="line"></div><div class="line"><span class="k">struct</span> <span class="n">editorConfig</span> <span class="n">E</span><span class="p">;</span></div><div class="line"></div><ins class="line"><span class="cm">/*** prototypes ***/</span></ins><ins class="line"></ins><ins class="line"><span class="kt">void</span> <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>

<h2 id="dirty-flag"><a href="#dirty-flag">Dirty flag</a></h2>

<p>We&rsquo;d like to keep track of whether the text loaded in our editor differs from
what&rsquo;s in the file. Then we can warn the user that they might lose unsaved
changes when they try to quit.</p>

<p>We call a text buffer &ldquo;dirty&rdquo; if it has been modified since opening or saving
the file. Let&rsquo;s add a <code>dirty</code> variable to the global editor state, and
initialize it to <code>0</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/dirty/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 111</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/dirty">dirty</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line"><span class="cm">/*** data ***/</span></div><div class="line"></div><div class="line folded"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">erow</span> <span class="p">{</span> &hellip; <span class="p">}</span> <span class="n">erow</span><span class="p">;</span></div><div class="line"></div><div class="line"><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span></div><div class="line">  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">rx</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">rowoff</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">coloff</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span></div><div class="line">  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span></div><ins class="line">  <span class="kt">int</span> <span class="n">dirty</span><span class="p">;</span></ins><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="n">statusmsg</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span></div><div class="line">  <span class="kt">time_t</span> <span class="n">statusmsg_time</span><span class="p">;</span></div><div class="line">  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span></div><div class="line"><span class="p">};</span></div><div class="line"></div><div class="line"><span class="k">struct</span> <span class="n">editorConfig</span> <span class="n">E</span><span class="p">;</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line"><span class="cm">/*** init ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></ins><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span> &hellip; <span class="p">}</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>Let&rsquo;s show the state of <code>E.dirty</code> in the status bar, by displaying <code>(modified)</code>
after the filename if the file has been modified.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/show-dirty/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 112</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/show-dirty">show-dirty</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line"><span class="cm">/*** output ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorScroll</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorDrawStatusBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></div><div class="line">  <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">80</span><span class="p">],</span> <span class="n">rstatus</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span></div><ins class="line">  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="s">"%.20s - %d lines %s"</span><span class="p">,</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">?</span> <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">:</span> <span class="s">"[No Name]"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">,</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">?</span> <span class="s">"(modified)"</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span></ins><div class="line">  <span class="kt">int</span> <span class="n">rlen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">rstatus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rstatus</span><span class="p">),</span> <span class="s">"%d/%d"</span><span class="p">,</span></div><div class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span></div><div class="line">  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></div><div class="line">  <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">len</span> <span class="o">==</span> <span class="n">rlen</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">rstatus</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div><div class="line">      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></div><div class="line">      <span class="n">len</span><span class="o">++</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><div class="line">  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></div><div class="line">  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorDrawMessageBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorSetStatusMessage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>Now let&rsquo;s increment <code>E.dirty</code> in each row operation that makes a change to the
text.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/increment-dirty/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 113</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/increment-dirty">increment-dirty</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line"><span class="cm">/*** row operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">at</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></div><div class="line">  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line">  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span></div><div class="line"></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span></div><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span></ins><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="n">at</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span></div><div class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span></div><div class="line">  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></div><div class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span></div><div class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span></div><div class="line">  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span></div><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span></ins><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>We could have used <code>E.dirty = 1</code> instead of <code>E.dirty++</code>, but by incrementing it
we can have a sense of &ldquo;how dirty&rdquo; the file is, which could be useful. (We&rsquo;ll
just be treating <code>E.dirty</code> as a boolean value in this tutorial, so it doesn&rsquo;t
really matter.)</p>

<p>If you open a file at this point, you&rsquo;ll see that <code>(modified)</code> appears right
away, before you make any changes. That&rsquo;s because <code>editorOpen()</code> calls
<code>editorAppendRow()</code>, which increments <code>E.dirty</code>. To fix that, let&rsquo;s reset
<code>E.dirty</code> to <code>0</code> at the end of <code>editorOpen()</code>, and also in <code>editorSave()</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/reset-dirty/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 114</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/reset-dirty">reset-dirty</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line">  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span></div><div class="line">  <span class="k">while</span> <span class="p">((</span><span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span></div><div class="line">                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span></div><div class="line">      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span></div><div class="line">    <span class="n">editorAppendRow</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span></div><div class="line">  <span class="p">}</span></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span></div><div class="line">  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span></div><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></ins><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><ins class="line">        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></ins><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></div><div class="line">        <span class="k">return</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">    <span class="p">}</span></div><div class="line">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>Now you should see <code>(modified)</code> appear in the status bar when you first insert
a character, and you should see it disappear when you save the file to disk.</p>
<h2 id="quit-confirmation"><a href="#quit-confirmation">Quit confirmation</a></h2>

<p>Now we&rsquo;re ready to warn the user about unsaved changes when they try to quit.
If <code>E.dirty</code> is set, we will display a warning in the status bar, and require
the user to press <kbd>Ctrl-Q</kbd> three more times in order to quit without
saving.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/quit-confirmation/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 115</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/quit-confirmation">quit-confirmation</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line"><span class="cm">/*** defines ***/</span></div><div class="line"></div><div class="line"><span class="cp">#define KILO_VERSION "0.0.1"</span></div><div class="line"><span class="cp">#define KILO_TAB_STOP 8</span></div><ins class="line"><span class="cp">#define KILO_QUIT_TIMES 3</span></ins><div class="line"></div><div class="line"><span class="cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span></div><div class="line"></div><div class="line folded"><span class="k">enum</span> <span class="n">editorKey</span> <span class="p">{</span> &hellip; <span class="p">};</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span></div><ins class="line">  <span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span></ins><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><div class="line"></div><div class="line">  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span></div><div class="line">      <span class="cm">/* TODO */</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span></div><ins class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span></ins><ins class="line">          <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span></ins><ins class="line">        <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span></ins><ins class="line">        <span class="k">return</span><span class="p">;</span></ins><ins class="line">      <span class="p">}</span></ins><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></div><div class="line">      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span></div><div class="line">      <span class="n">editorSave</span><span class="p">();</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span></div><div class="line">      <span class="cm">/* TODO */</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span></div><div class="line">      <span class="p">{</span></div><div class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></div><div class="line">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">        <span class="p">}</span></div><div class="line"></div><div class="line">        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span></div><div class="line">        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span></div><div class="line">          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span></div><div class="line">      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="nl">default:</span></div><div class="line">      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><ins class="line">  <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span></ins><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>We use a static variable in <code>editorProcessKeypress()</code> to keep track of how many
more times the user must press <kbd>Ctrl-Q</kbd> to quit. Each time they press
<kbd>Ctrl-Q</kbd> with unsaved changes, we set the status message and decrement
<code>quit_times</code>. When <code>quit_times</code> gets to <code>0</code>, we finally allow the program to
exit. When they press any key other than <kbd>Ctrl-Q</kbd>, then <code>quit_times</code>
gets reset back to <code>3</code> at the end of the <code>editorProcessKeypress()</code> function.</p>
<h2 id="simple-backspacing"><a href="#simple-backspacing">Simple backspacing</a></h2>

<p>Let&rsquo;s implement backspacing next. First we&rsquo;ll create an <code>editorRowDelChar()</code>
function, which deletes a character in an <code>erow</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/row-del-char/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 116</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/row-del-char">row-del-char</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line"><span class="cm">/*** row operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="nf">editorRowDelChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></ins><ins class="line">  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">at</span><span class="p">);</span></ins><ins class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">--</span><span class="p">;</span></ins><ins class="line">  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span></ins><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>As you can see, it&rsquo;s very similar to <code>editorRowInsertChar()</code>, except we don&rsquo;t
have any memory management to do. We just use <code>memmove()</code> to overwrite the
deleted character with the characters that come after it (notice that the null
byte at the end gets included in the move). Then we decrement the row&rsquo;s <code>size</code>,
call <code>editorUpdateRow()</code>, and increment <code>E.dirty</code>.</p>

<p>Now let&rsquo;s implement <code>editorDelChar()</code>, which uses <code>editorRowDelChar()</code> to
delete the character that is to the left of the cursor.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/editor-del-char/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 117</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/editor-del-char">editor-del-char</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line"><span class="cm">/*** editor operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorInsertChar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="nf">editorDelChar</span><span class="p">()</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></ins><ins class="line"></ins><ins class="line">  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">editorRowDelChar</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span></ins><ins class="line">  <span class="p">}</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>If the cursor&rsquo;s past the end of the file, then there is nothing to delete, and
we <code>return</code> immediately. Otherwise, we get the <code>erow</code> the cursor is on, and if
there is a character to the left of the cursor, we delete it and move the
cursor one to the left.</p>

<p>Let&rsquo;s map the <kbd>Backspace</kbd>, <kbd>Ctrl-H</kbd>, and <kbd>Delete</kbd>
keys to <code>editorDelChar()</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/key-del-char/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 118</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/key-del-char">key-del-char</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><div class="line"></div><div class="line">  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span></div><div class="line">      <span class="cm">/* TODO */</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span></div><div class="line">          <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span></div><div class="line">        <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span></div><div class="line">        <span class="k">return</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></div><div class="line">      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span></div><div class="line">      <span class="n">editorSave</span><span class="p">();</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span></div><ins class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span><span class="p">)</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">ARROW_RIGHT</span><span class="p">);</span></ins><ins class="line">      <span class="n">editorDelChar</span><span class="p">();</span></ins><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span></div><div class="line">      <span class="p">{</span></div><div class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></div><div class="line">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">        <span class="p">}</span></div><div class="line"></div><div class="line">        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span></div><div class="line">        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span></div><div class="line">          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span></div><div class="line">      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="nl">default:</span></div><div class="line">      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>It so happens that in our editor, pressing the <kbd>&rarr;</kbd> key and then
<kbd>Backspace</kbd> is equivalent to what you would expect from pressing the
<kbd>Delete</kbd> key in a text editor: it deletes the character to the right
of the cursor. So that is how we implement the <kbd>Delete</kbd> key above.</p>
<h2 id="backspacing-at-the-start-of-a-line"><a href="#backspacing-at-the-start-of-a-line">Backspacing at the start of a line</a></h2>

<p>Currently, <code>editorDelChar()</code> doesn&rsquo;t do anything when the cursor is at the
beginning of a line. When the user backspaces at the beginning of a line, we
want to append the contents of that line to the previous line, and then delete
the current line. This effectively backspaces the implicit <code>\n</code> character in
between the two lines to join them into one line.</p>

<p>So we need two new row operations: one for appending a string to a row, and one
for deleting a row. Let&rsquo;s start by implementing <code>editorDelRow()</code>, which will
also require an <code>editorFreeRow()</code> function for freeing the memory owned by the
<code>erow</code> we are deleting.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/del-row/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 119</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/del-row">del-row</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line"><span class="cm">/*** row operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="nf">editorFreeRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span></ins><ins class="line">  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">);</span></ins><ins class="line"><span class="p">}</span></ins><ins class="line"></ins><ins class="line"><span class="kt">void</span> <span class="nf">editorDelRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></ins><ins class="line">  <span class="n">editorFreeRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span></ins><ins class="line">  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="n">at</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span></ins><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">--</span><span class="p">;</span></ins><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowDelChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p><code>editorDelRow()</code> looks a lot like <code>editorRowDelChar()</code>, because in both cases
we are deleting a single element from an array of elements by its index.</p>

<p>First we validate the <code>at</code> index. Then we free the memory owned by the row
using <code>editorFreeRow()</code>. We then use <code>memmove()</code> to overwrite the deleted row
struct with the rest of the rows that come after it, and decrement <code>numrows</code>.
Finally, we increment <code>E.dirty</code>.</p>

<p>Now let&rsquo;s implement <code>editorRowAppendString()</code>, which appends a string to the
end of a row.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/row-append-string/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 120</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/row-append-string">row-append-string</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line"><span class="cm">/*** row operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorFreeRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorDelRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="nf">editorRowAppendString</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></ins><ins class="line">  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></ins><ins class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span></ins><ins class="line">  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></ins><ins class="line">  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span></ins><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowDelChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>The row&rsquo;s new size is <code>row-&gt;size + len + 1</code> (including the null byte), so first
we allocate that much memory for <code>row-&gt;chars</code>. Then we simply <code>memcpy()</code> the
given string to the end of the contents of <code>row-&gt;chars</code>. We update <code>row-&gt;size</code>,
call <code>editorUpdateRow()</code> as usual, and increment <code>E.dirty</code> as usual.</p>

<p>Now we&rsquo;re ready to get <code>editorDelChar()</code> to handle the case where the cursor is
at the beginning of a line.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/del-char-row/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 121</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/del-char-row">del-char-row</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line"><span class="cm">/*** editor operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorInsertChar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorDelChar</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></div><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></ins><div class="line"></div><div class="line">  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">editorRowDelChar</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span></div><div class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span></div><ins class="line">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></ins><ins class="line">    <span class="n">editorRowAppendString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span></ins><ins class="line">    <span class="n">editorDelRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">);</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span></ins><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>If the cursor is at the beginning of the <em>first</em> line, then there&rsquo;s nothing to
do, so we <code>return</code> immediately. Otherwise, if we find that <code>E.cx == 0</code>, we call
<code>editorRowAppendString()</code> and then <code>editorDelRow()</code> as we planned. <code>row</code> points
to the row we are deleting, so we append <code>row-&gt;chars</code> to the previous row, and
then delete the row that <code>E.cy</code> is on. We set <code>E.cx</code> to the end of the contents
of the previous row before appending to that row. That way, the cursor will end
up at the point where the two lines joined.</p>

<p>Notice that pressing the <kbd>Delete</kbd> key at the end of a line works as
the user would expect, joining the current line with the next line. This is
because moving the cursor to the right at the end of a line moves it to the
beginning of the next line. So making the <kbd>Delete</kbd> key an alias for
the <kbd>&rarr;</kbd> key followed by the <kbd>Backspace</kbd> key still works.</p>
<h2 id="the-enter-key"><a href="#the-enter-key">The <kbd>Enter</kbd> key</a></h2>

<p>The last editor operation we have to implement is the <kbd>Enter</kbd> key. The
<kbd>Enter</kbd> key allows the user to insert new lines into the text, or
split a line into two lines. The first thing we need to do is rename the
<code>editorAppendRow(...)</code> function to <code>editorInsertRow(int at, ...)</code>. It will now
be able to insert a row at the index specified by the new <code>at</code> argument.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/append-to-insert/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 122</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/append-to-insert">append-to-insert</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line"><span class="cm">/*** row operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="n">editorInsertRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></ins><ins class="line"></ins><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span></ins><ins class="line">  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="n">at</span><span class="p">));</span></ins><div class="line"></div><del class="line">  <span class="kt">int</span> <span class="n">at</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></del><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></div><div class="line">  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line">  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span></div><div class="line"></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorFreeRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorDelRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorRowAppendString</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorRowDelChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c0">♏&#xFE0E; doesn’t compile</div>
</div>
</div>


<p>Much like <code>editorRowInsertChar()</code>, we first validate <code>at</code>, then allocate memory
for one more <code>erow</code>, and use <code>memmove()</code> to make room at the specified index
for the new row.</p>

<p>We also delete the old <code>int at = ...</code> line, since <code>at</code> is now being passed in
as an argument.</p>

<p>We now have to replace all calls to <code>editorAppendRow(...)</code> with calls to
<code>editorInsertRow(E.numrows, ...)</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/use-insert-row/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 123</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/use-insert-row">use-insert-row</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line"><span class="cm">/*** editor operations ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorInsertChar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span></div><ins class="line">    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></ins><div class="line">  <span class="p">}</span></div><div class="line">  <span class="n">editorRowInsertChar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">],</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorDelChar</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line">  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span></div><div class="line">  <span class="k">while</span> <span class="p">((</span><span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span></div><div class="line">                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span></div><div class="line">      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span></div><ins class="line">    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span></ins><div class="line">  <span class="p">}</span></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span></div><div class="line">  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span></div><div class="line">  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>Now that we have <code>editorInsertRow()</code>, we&rsquo;re ready to implement
<code>editorInsertNewline()</code>, which handles an <kbd>Enter</kbd> keypress.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/insert-newline/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 124</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/insert-newline">insert-newline</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line"><span class="cm">/*** editor operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorInsertChar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="nf">editorInsertNewline</span><span class="p">()</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></ins><ins class="line">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></ins><ins class="line">    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span></ins><ins class="line">    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">);</span></ins><ins class="line">    <span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span></ins><ins class="line">    <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span></ins><ins class="line">    <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></ins><ins class="line">    <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span></ins><ins class="line">  <span class="p">}</span></ins><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span></ins><ins class="line">  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorDelChar</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>If we&rsquo;re at the beginning of a line, all we have to do is insert a new blank
row before the line we&rsquo;re on.</p>

<p>Otherwise, we have to split the line we&rsquo;re on into two rows. First we call
<code>editorInsertRow()</code> and pass it the characters on the current row that are to
the right of the cursor. That creates a new row after the current one, with the
correct contents. Then we reassign the <code>row</code> pointer, because
<code>editorInsertRow()</code> calls <code>realloc()</code>, which might move memory around on us and
invalidate the pointer (yikes). Then we truncate the current row&rsquo;s contents by
setting its size to the position of the cursor, and we call
<code>editorUpdateRow()</code> on the truncated row. (<code>editorInsertRow()</code> already calls
<code>editorUpdateRow()</code> for the new row.)</p>

<p>In both cases, we increment <code>E.cy</code>, and set <code>E.cx</code> to <code>0</code> to move the cursor to
the beginning of the row.</p>

<p>Finally, let&rsquo;s actually map the <kbd>Enter</kbd> key to the
<code>editorInsertNewline()</code> operation.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/enter-key/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 125</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/enter-key">enter-key</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><div class="line"></div><div class="line">  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span></div><ins class="line">      <span class="n">editorInsertNewline</span><span class="p">();</span></ins><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span></div><div class="line">          <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span></div><div class="line">        <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span></div><div class="line">        <span class="k">return</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></div><div class="line">      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span></div><div class="line">      <span class="n">editorSave</span><span class="p">();</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span><span class="p">)</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">ARROW_RIGHT</span><span class="p">);</span></div><div class="line">      <span class="n">editorDelChar</span><span class="p">();</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span></div><div class="line">      <span class="p">{</span></div><div class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></div><div class="line">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">        <span class="p">}</span></div><div class="line"></div><div class="line">        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span></div><div class="line">        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span></div><div class="line">          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span></div><div class="line">      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="nl">default:</span></div><div class="line">      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>That concludes all of the text editing operations we are going to implement. If
you wish, and if you are brave enough, you may now start using the editor to
modify its own code for the rest of the tutorial. If you do, I suggest making
regular backups of your work (using <code>git</code> or similar) in case you run into bugs
in the editor.</p>
<h2 id="save-as"><a href="#save-as">Save as&hellip;</a></h2>

<p>Currently, when the user runs <code>./kilo</code> with no arguments, they get a blank file
to edit but have no way of saving. We need a way of prompting the user to input
a filename when saving a new file. Let&rsquo;s make an <code>editorPrompt()</code> function that
displays a prompt in the status bar, and lets the user input a line of text
after the prompt.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/prompt/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 126</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/prompt">prompt</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line"><span class="cm">/*** prototypes ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span></div><ins class="line"><span class="kt">void</span> <span class="n">editorRefreshScreen</span><span class="p">();</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><ins class="line"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span></ins><ins class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">);</span></ins><ins class="line"></ins><ins class="line">  <span class="kt">size_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></ins><ins class="line">  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></ins><ins class="line"></ins><ins class="line">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span></ins><ins class="line">    <span class="n">editorRefreshScreen</span><span class="p">();</span></ins><ins class="line"></ins><ins class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></ins><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span></ins><ins class="line">        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span></ins><ins class="line">      <span class="p">}</span></ins><ins class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">        <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span></ins><ins class="line">        <span class="n">buf</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span></ins><ins class="line">      <span class="p">}</span></ins><ins class="line">      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span></ins><ins class="line">      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></ins><ins class="line">    <span class="p">}</span></ins><ins class="line">  <span class="p">}</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>The user&rsquo;s input is stored in <code>buf</code>, which is a dynamically allocated string
that we initalize to the empty string. We then enter an infinite loop that
repeatedly sets the status message, refreshes the screen, and waits for a
keypress to handle. The <code>prompt</code> is expected to be a format string containing a
<code>%s</code>, which is where the user&rsquo;s input will be displayed.</p>

<p>When the user presses <kbd>Enter</kbd>, and their input is not empty, the
status message is cleared and their input is returned. Otherwise, when they
input a printable character, we append it to <code>buf</code>. If <code>buflen</code> has reached the
maximum capacity we allocated (stored in <code>bufsize</code>), then we double <code>bufsize</code>
and allocate that amount of memory before appending to <code>buf</code>. We also make sure
that <code>buf</code> ends with a <code>\0</code> character, because both <code>editorSetStatusMessage()</code>
and the caller of <code>editorPrompt()</code> will use it to know where the string ends.</p>

<p>Notice that we have to make sure the input key isn&rsquo;t one of the special keys in
the <code>editorKey</code> enum, which have high integer values. To do that, we test
whether the input key is in the range of a <code>char</code> by making sure it is less
than <code>128</code>.</p>

<p>Now let&rsquo;s prompt the user for a filename in <code>editorSave()</code>, when <code>E.filename</code>
is <code>NULL</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/save-as/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 127</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/save-as">save-as</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line"><span class="cm">/*** prototypes ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span></div><div class="line"><span class="kt">void</span> <span class="n">editorRefreshScreen</span><span class="p">();</span></div><ins class="line"><span class="kt">char</span> <span class="o">*</span><span class="n">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">);</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span></div><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Save as: %s"</span><span class="p">);</span></ins><ins class="line">  <span class="p">}</span></ins><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></div><div class="line">        <span class="k">return</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">    <span class="p">}</span></div><div class="line">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>Great, we now have basic &ldquo;Save as&hellip;&rdquo; functionality. Next, let&rsquo;s allow the user 
to press <kbd>Escape</kbd> to cancel the input prompt.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/prompt-escape/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 128</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/prompt-escape">prompt-escape</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">size_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span></div><div class="line">    <span class="n">editorRefreshScreen</span><span class="p">();</span></div><div class="line"></div><div class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span></ins><ins class="line">      <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></ins><ins class="line">      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span></ins><ins class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span></ins><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span></div><div class="line">        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span></div><div class="line">        <span class="n">buf</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span></div><div class="line">      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>When an input prompt is cancelled, we <code>free()</code> the <code>buf</code> ourselves and return
<code>NULL</code>. So let&rsquo;s handle a return value of <code>NULL</code> in <code>editorSave()</code> by aborting
the save operation and displaying a &ldquo;Save aborted&rdquo; message to the user.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/abort-save/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 129</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/abort-save">abort-save</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></div><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Save as: %s (ESC to cancel)"</span><span class="p">);</span></ins><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Save aborted"</span><span class="p">);</span></ins><ins class="line">      <span class="k">return</span><span class="p">;</span></ins><ins class="line">    <span class="p">}</span></ins><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></div><div class="line">        <span class="k">return</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">    <span class="p">}</span></div><div class="line">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>(Note: If you&rsquo;re using <strong>Bash on Windows</strong>, you will have to press
<kbd>Escape</kbd> 3 times to get one <kbd>Escape</kbd> keypress to register in
our program, because the <code>read()</code> calls in <code>editorReadKey()</code> that look for an
escape sequence never time out.)</p>

<p>Now let&rsquo;s allow the user to press <kbd>Backspace</kbd> (or <kbd>Ctrl-H</kbd>,
or <kbd>Delete</kbd>) in the input prompt.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/prompt-backspace/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 130</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/prompt-backspace">prompt-backspace</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">size_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span></div><div class="line">    <span class="n">editorRefreshScreen</span><span class="p">();</span></div><div class="line"></div><div class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">BACKSPACE</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="o">--</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></ins><ins class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span></ins><div class="line">      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span></div><div class="line">      <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span></div><div class="line">        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span></div><div class="line">        <span class="n">buf</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span></div><div class="line">      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>In the <a href="06.search.html">next chapter</a>, we&rsquo;ll make use of <code>editorPrompt()</code> to
implement an incremental search feature in our editor.</p>

    </div>
    <div id="version">
      <a href="https://github.com/snaptoken/kilo-tutorial/tree/v1.0.0beta11">1.0.0beta11</a>
      (<a href="https://github.com/snaptoken/kilo-tutorial/blob/master/CHANGELOG.md">changelog</a>)
    </div>
    <footer class="bar">
      <nav>
        <a href="#">top of page</a>
      </nav>
    </footer>
  </body>
</html>


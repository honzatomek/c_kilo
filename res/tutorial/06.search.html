<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>6. Search | Build Your Own Text Editor</title>
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <header class="bar">
      <nav>
        <a href='05.aTextEditor.html'>&larr; prev</a>
        <a href="index.html">contents</a>
        <a href='07.syntaxHighlighting.html'>next &rarr;</a>
      </nav>
    </header>
    <div id="container">
      <h1 id="search">Search</h1>

<p>Let&rsquo;s use <code>editorPrompt()</code> to implement a minimal search feature. When the user
types a search query and presses <kbd>Enter</kbd>, we&rsquo;ll loop through all the
rows of the file, and if a row contains their query string, we&rsquo;ll move the
cursor to the match.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/basic-search/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 131</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/basic-search">basic-search</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="cm">/*** find ***/</span></ins><ins class="line"></ins><ins class="line"><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span></ins><ins class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">);</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></ins><ins class="line"></ins><ins class="line">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span></ins><ins class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></ins><ins class="line">    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span></ins><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span></ins><ins class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">;</span></ins><ins class="line">      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></ins><ins class="line">      <span class="k">break</span><span class="p">;</span></ins><ins class="line">    <span class="p">}</span></ins><ins class="line">  <span class="p">}</span></ins><ins class="line"></ins><ins class="line">  <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p><code>strstr()</code> comes from <code>&lt;string.h&gt;</code>.</p>

<p>If they pressed <kbd>Escape</kbd> to cancel the input prompt, then
<code>editorPrompt()</code> returns <code>NULL</code> and we abort the search.</p>

<p>Otherwise, we loop through all the rows of the file. We use <code>strstr()</code> to check
if <code>query</code> is a substring of the current row. It returns <code>NULL</code> if there is no
match, otherwise it returns a pointer to the matching substring. To convert
that into an index that we can set <code>E.cx</code> to, we subtract the <code>row-&gt;render</code>
pointer from the <code>match</code> pointer, since <code>match</code> is a pointer into the
<code>row-&gt;render</code> string. Lastly, we set <code>E.rowoff</code> so that we are scrolled to the
very bottom of the file, which will cause <code>editorScroll()</code> to scroll upwards at
the next screen refresh so that the matching line will be at the very top of
the screen. This way, the user doesn&rsquo;t have to look all over their screen to
find where their cursor jumped to, and where the matching line is.</p>

<p>There&rsquo;s one problem here. Did you notice what we just did wrong? We assigned a
<code>render</code> index to <code>E.cx</code>, but <code>E.cx</code> is an index into <code>chars</code>. If there are
tabs to the left of the match, the cursor is going to be in the wrong position.
We need to convert the <code>render</code> index into a <code>chars</code> index before assigning it
to <code>E.cx</code>. Let&rsquo;s create an <code>editorRowRxToCx()</code> function, which is the opposite
of the <code>editorRowCxToRx()</code> function we wrote in
<a href="04.aTextViewer.html#tabs-and-the-cursor">chapter 4</a>, but contains a lot of the
same code.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/rx-to-cx/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 132</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/rx-to-cx">rx-to-cx</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line"><span class="cm">/*** row operations ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><ins class="line"><span class="kt">int</span> <span class="nf">editorRowRxToCx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="kt">int</span> <span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></ins><ins class="line">  <span class="kt">int</span> <span class="n">cx</span><span class="p">;</span></ins><ins class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cx</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">cx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span></ins><ins class="line">      <span class="n">cur_rx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">KILO_TAB_STOP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">KILO_TAB_STOP</span><span class="p">);</span></ins><ins class="line">    <span class="n">cur_rx</span><span class="o">++</span><span class="p">;</span></ins><ins class="line"></ins><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">cur_rx</span> <span class="o">&gt;</span> <span class="n">rx</span><span class="p">)</span> <span class="k">return</span> <span class="n">cx</span><span class="p">;</span></ins><ins class="line">  <span class="p">}</span></ins><ins class="line">  <span class="k">return</span> <span class="n">cx</span><span class="p">;</span></ins><ins class="line"><span class="p">}</span></ins><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorInsertRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorFreeRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorDelRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowAppendString</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorRowDelChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** find ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>To convert an <code>rx</code> into a <code>cx</code>, we do pretty much the same thing when
converting the other way: loop through the <code>chars</code> string, calculating the
current <code>rx</code> value (<code>cur_rx</code>) as we go. But instead of stopping when we hit a
particular <code>cx</code> value and returning <code>cur_rx</code>, we want to stop when <code>cur_rx</code>
hits the given <code>rx</code> value and return <code>cx</code>.</p>

<p>The <code>return</code> statement at the very end is just in case the caller provided an
<code>rx</code> that&rsquo;s out of range, which shouldn&rsquo;t happen. The <code>return</code> statement inside
the <code>for</code> loop should handle all <code>rx</code> values that are valid indexes into
<code>render</code>.</p>

<p>Now let&rsquo;s call <code>editorRowRxToCx()</code> to convert the matched index to a <code>chars</code>
index and assign that to <code>E.cx</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/use-rx-to-cx/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 133</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/use-rx-to-cx">use-rx-to-cx</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line"><span class="cm">/*** find ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span></div><div class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></div><div class="line">    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span></div><ins class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span></ins><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>Finally, let&rsquo;s map <kbd>Ctrl-F</kbd> to the <code>editorFind()</code> function, and add it
to the help message we set in <code>main()</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/ctrl-f/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 134</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/ctrl-f">ctrl-f</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** find ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><div class="line"></div><div class="line">  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span></div><div class="line">      <span class="n">editorInsertNewline</span><span class="p">();</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span></div><div class="line">          <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span></div><div class="line">        <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span></div><div class="line">        <span class="k">return</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></div><div class="line">      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span></div><div class="line">      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span></div><div class="line">      <span class="n">editorSave</span><span class="p">();</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><ins class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'f'</span><span class="p">):</span></ins><ins class="line">      <span class="n">editorFind</span><span class="p">();</span></ins><ins class="line">      <span class="k">break</span><span class="p">;</span></ins><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span><span class="p">)</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">ARROW_RIGHT</span><span class="p">);</span></div><div class="line">      <span class="n">editorDelChar</span><span class="p">();</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span></div><div class="line">      <span class="p">{</span></div><div class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></div><div class="line">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span></div><div class="line">          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">        <span class="p">}</span></div><div class="line"></div><div class="line">        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span></div><div class="line">        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span></div><div class="line">          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span></div><div class="line">    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span></div><div class="line">      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span></div><div class="line">    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line"></div><div class="line">    <span class="nl">default:</span></div><div class="line">      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line"><span class="cm">/*** init ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span></div><div class="line">  <span class="n">enableRawMode</span><span class="p">();</span></div><div class="line">  <span class="n">initEditor</span><span class="p">();</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">editorOpen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><ins class="line">  <span class="n">editorSetStatusMessage</span><span class="p">(</span></ins><ins class="line">    <span class="s">"HELP: Ctrl-S = save | Ctrl-Q = quit | Ctrl-F = find"</span><span class="p">);</span></ins><div class="line"></div><div class="line">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">editorRefreshScreen</span><span class="p">();</span></div><div class="line">    <span class="n">editorProcessKeypress</span><span class="p">();</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span></div><div class="line"><span class="p">}</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>

<h2 id="incremental-search"><a href="#incremental-search">Incremental search</a></h2>

<p>Now, let&rsquo;s make our search feature fancy. We want to support incremental
search, meaning the file is searched after each keypress when the user is
typing in their search query.</p>

<p>To implement this, we&rsquo;re going to get <code>editorPrompt()</code> to take a callback
function as an argument. We&rsquo;ll have it call this function after each keypress,
passing the current search query inputted by the user and the last key they
pressed.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/prompt-callback/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 135</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/prompt-callback">prompt-callback</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line"><span class="cm">/*** prototypes ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span></div><div class="line"><span class="kt">void</span> <span class="n">editorRefreshScreen</span><span class="p">();</span></div><ins class="line"><span class="kt">char</span> <span class="o">*</span><span class="n">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span></ins><div class="line"></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line folded"><span class="cm">/*** find ***/</span></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line"><span class="cm">/*** input ***/</span></div><div class="line"></div><ins class="line"><span class="kt">char</span> <span class="o">*</span><span class="n">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span> <span class="p">{</span></ins><div class="line">  <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">size_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span></div><div class="line">    <span class="n">editorRefreshScreen</span><span class="p">();</span></div><div class="line"></div><div class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">BACKSPACE</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="o">--</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span></div><ins class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="n">callback</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span></ins><div class="line">      <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span></div><ins class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="n">callback</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span></ins><div class="line">        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span></div><div class="line">        <span class="n">buf</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span></div><div class="line">      <span class="p">}</span></div><div class="line">      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span></div><div class="line">      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line"></div><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="n">callback</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span></ins><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="n">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c0">♏&#xFE0E; doesn’t compile</div>
</div>
</div>


<p>The <code>if</code> statements allow the caller to pass <code>NULL</code> for the callback, in case
they don&rsquo;t want to use a callback. This is the case when we prompt the user
for a filename, so let&rsquo;s pass <code>NULL</code> to <code>editorPrompt()</code> when we do that. We&rsquo;ll
also pass <code>NULL</code> to <code>editorPrompt()</code> in <code>editorFind()</code> for now, to get the code
to compile.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/null-callback/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 136</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/null-callback">null-callback</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line"><span class="cm">/*** file i/o ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></div><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Save as: %s (ESC to cancel)"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span></ins><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Save aborted"</span><span class="p">);</span></div><div class="line">      <span class="k">return</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span></div><div class="line">        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line">        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span></div><div class="line">        <span class="k">return</span><span class="p">;</span></div><div class="line">      <span class="p">}</span></div><div class="line">    <span class="p">}</span></div><div class="line">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span></div><div class="line">  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line"><span class="cm">/*** find ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span></div><ins class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span></ins><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span></div><div class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></div><div class="line">    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>Now let&rsquo;s move the actual searching code from <code>editorFind()</code> into a function
called <code>editorFindCallback()</code>. Obviously this will be our callback function for
<code>editorPrompt()</code>.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/incremental-search/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 137</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/incremental-search">incremental-search</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line"><span class="cm">/*** find ***/</span></div><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="n">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="k">return</span><span class="p">;</span></ins><ins class="line">  <span class="p">}</span></ins><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span></div><div class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></div><div class="line">    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><ins class="line"><span class="p">}</span></ins><div class="line"></div><ins class="line"><span class="kt">void</span> <span class="n">editorFind</span><span class="p">()</span> <span class="p">{</span></ins><ins class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">,</span> <span class="n">editorFindCallback</span><span class="p">);</span></ins><ins class="line"></ins><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span></ins><div class="line">    <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span></div><ins class="line">  <span class="p">}</span></ins><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>In the callback, we check if the user pressed <kbd>Enter</kbd> or
<kbd>Escape</kbd>, in which case they are leaving search mode so we <code>return</code>
immediately instead of doing another search. Otherwise, after any other
keypress, we do another search for the current <code>query</code> string.</p>

<p>That&rsquo;s all there is to it. We now have incremental search.</p>
<h2 id="restore-cursor-position-when-cancelling-search"><a href="#restore-cursor-position-when-cancelling-search">Restore cursor position when cancelling search</a></h2>

<p>When the user presses <kbd>Escape</kbd> to cancel a search, we want the cursor
to go back to where it was when they started the search. To do that, we&rsquo;ll have
to save their cursor position and scroll position, and restore those values
after the search is cancelled.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/restore-cursor/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 138</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/restore-cursor">restore-cursor</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line"><span class="cm">/*** find ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span></div><ins class="line">  <span class="kt">int</span> <span class="n">saved_cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span></ins><ins class="line">  <span class="kt">int</span> <span class="n">saved_cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span></ins><ins class="line">  <span class="kt">int</span> <span class="n">saved_coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span></ins><ins class="line">  <span class="kt">int</span> <span class="n">saved_rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></ins><div class="line"></div><div class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">,</span> <span class="n">editorFindCallback</span><span class="p">);</span></div><div class="line"></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span></div><ins class="line">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">saved_cx</span><span class="p">;</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">saved_cy</span><span class="p">;</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">saved_coloff</span><span class="p">;</span></ins><ins class="line">    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">saved_rowoff</span><span class="p">;</span></ins><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>If <code>query</code> is <code>NULL</code>, that means they pressed <kbd>Escape</kbd>, so in that
case we restore the values we saved.</p>
<h2 id="search-forward-and-backward"><a href="#search-forward-and-backward">Search forward and backward</a></h2>

<p>The last feature we&rsquo;d like to add is to allow the user to advance to the next
or previous match in the file using the arrow keys. The <kbd>&uarr;</kbd> and
<kbd>&larr;</kbd> keys will go to the previous match, and the <kbd>&darr;</kbd>
and <kbd>&rarr;</kbd> keys will go to the next match.</p>

<p>We&rsquo;ll implement this feature using two static variables in our callback.
<code>last_match</code> will contain the index of the row that the last match was on, or
<code>-1</code> if there was no last match. And <code>direction</code> will store the direction of
the search: <code>1</code> for searching forward, and <code>-1</code> for searching backward.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/callback-statics/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 139</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/callback-statics">callback-statics</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line"><span class="cm">/*** find ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span></div><ins class="line">  <span class="k">static</span> <span class="kt">int</span> <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></ins><ins class="line">  <span class="k">static</span> <span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></ins><div class="line"></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span></div><ins class="line">    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></ins><ins class="line">    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></ins><div class="line">    <span class="k">return</span><span class="p">;</span></div><ins class="line">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_RIGHT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_DOWN</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></ins><ins class="line">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_LEFT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_UP</span><span class="p">)</span> <span class="p">{</span></ins><ins class="line">    <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></ins><ins class="line">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></ins><ins class="line">    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></ins><ins class="line">    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></ins><div class="line">  <span class="p">}</span></div><div class="line"></div><div class="line">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span></div><div class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></div><div class="line">    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c1">♎&#xFE0E; compiles, but with no observable effects</div>
</div>
</div>


<p>As you can see, we always reset <code>last_match</code> to <code>-1</code> unless an arrow key was
pressed. So we&rsquo;ll only advance to the next or previous match when an arrow key
is pressed. You can also see that we always set <code>direction</code> to <code>1</code> unless the
<kbd>&larr;</kbd> or <kbd>&uarr;</kbd> key was pressed. So we always search in
the forward direction unless the user specifically asks to search backwards
from the last match.</p>

<p>If <code>key</code> is <code>&#39;\r&#39;</code> (<kbd>Enter</kbd>) or <code>&#39;\x1b&#39;</code> (<kbd>Escape</kbd>), that
means we&rsquo;re about to leave search mode. So we reset <code>last_match</code> and
<code>direction</code> to their initial values to get ready for the next search operation.</p>

<p>Now that we have those variables all set up, let&rsquo;s put them to use.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/search-arrows/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 140</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/search-arrows">search-arrows</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line"><span class="cm">/*** find ***/</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span></div><div class="line">  <span class="k">static</span> <span class="kt">int</span> <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></div><div class="line">  <span class="k">static</span> <span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></div><div class="line"></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></div><div class="line">    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">    <span class="k">return</span><span class="p">;</span></div><div class="line">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_RIGHT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_DOWN</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_LEFT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_UP</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></div><div class="line">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div><div class="line">    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></div><div class="line">    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></div><div class="line">  <span class="p">}</span></div><div class="line"></div><ins class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">last_match</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></ins><ins class="line">  <span class="kt">int</span> <span class="n">current</span> <span class="o">=</span> <span class="n">last_match</span><span class="p">;</span></ins><div class="line">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span></div><div class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></div><ins class="line">    <span class="n">current</span> <span class="o">+=</span> <span class="n">direction</span><span class="p">;</span></ins><ins class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">current</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></ins><ins class="line">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></ins><ins class="line"></ins><ins class="line">    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">current</span><span class="p">];</span></ins><div class="line">    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span></div><div class="line">    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span></div><ins class="line">      <span class="n">last_match</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span></ins><ins class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span></ins><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span></div><div class="line">      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span></div><div class="line">      <span class="k">break</span><span class="p">;</span></div><div class="line">    <span class="p">}</span></div><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p><code>current</code> is the index of the current row we are searching. If there was a last
match, it starts on the line after (or before, if we&rsquo;re searching backwards).
If there wasn&rsquo;t a last match, it starts at the top of the file and searches in
the forward direction to find the first match.</p>

<p>The <code>if ... else if</code> causes <code>current</code> to go from the end of the file back to
the beginning of the file, or vice versa, to allow a search to &ldquo;wrap around&rdquo;
the end of a file and continue from the top (or bottom).</p>

<p>When we find a match, we set <code>last_match</code> to <code>current</code>, so that if the user
presses the arrow keys, we&rsquo;ll start the next search from that point.</p>

<p>Finally, let&rsquo;s not forget to update the prompt text to let the user know they
can use the arrow keys.</p>

<div class="diff">
<div class="diff-header">
  <div class="step-filename"><a href="https://github.com/snaptoken/kilo-src/blob/search-arrows-help/kilo.c">kilo.c</a></div>
  <div class="step-number">Step 141</div>
  <div class="step-name"><a href="https://github.com/snaptoken/kilo-src/tree/search-arrows-help">search-arrows-help</a></div>
</div><pre class="highlight"><code><div class="line folded"><span class="cm">/*** includes ***/</span></div><div class="line folded"><span class="cm">/*** defines ***/</span></div><div class="line folded"><span class="cm">/*** data ***/</span></div><div class="line folded"><span class="cm">/*** prototypes ***/</span></div><div class="line folded"><span class="cm">/*** terminal ***/</span></div><div class="line folded"><span class="cm">/*** row operations ***/</span></div><div class="line folded"><span class="cm">/*** editor operations ***/</span></div><div class="line folded"><span class="cm">/*** file i/o ***/</span></div><div class="line"><span class="cm">/*** find ***/</span></div><div class="line"></div><div class="line folded"><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span> &hellip; <span class="p">}</span></div><div class="line"></div><div class="line"><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span></div><div class="line">  <span class="kt">int</span> <span class="n">saved_cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">saved_cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">saved_coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span></div><div class="line">  <span class="kt">int</span> <span class="n">saved_rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span></div><div class="line"></div><ins class="line">  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (Use ESC/Arrows/Enter)"</span><span class="p">,</span></ins><ins class="line">                             <span class="n">editorFindCallback</span><span class="p">);</span></ins><div class="line"></div><div class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span></div><div class="line">    <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span></div><div class="line">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div><div class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">saved_cx</span><span class="p">;</span></div><div class="line">    <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">saved_cy</span><span class="p">;</span></div><div class="line">    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">saved_coloff</span><span class="p">;</span></div><div class="line">    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">saved_rowoff</span><span class="p">;</span></div><div class="line">  <span class="p">}</span></div><div class="line"><span class="p">}</span></div><div class="line"></div><div class="line folded"><span class="cm">/*** append buffer ***/</span></div><div class="line folded"><span class="cm">/*** output ***/</span></div><div class="line folded"><span class="cm">/*** input ***/</span></div><div class="line folded"><span class="cm">/*** init ***/</span></div></code></pre>
<div class="diff-footer">
  <div class="diff-tag-c2">♐&#xFE0E; compiles</div>
</div>
</div>


<p>In the <a href="07.syntaxHighlighting.html">next chapter</a>, we&rsquo;ll implement syntax
highlighting and filetype detection, to complete our text editor.</p>

    </div>
    <div id="version">
      <a href="https://github.com/snaptoken/kilo-tutorial/tree/v1.0.0beta11">1.0.0beta11</a>
      (<a href="https://github.com/snaptoken/kilo-tutorial/blob/master/CHANGELOG.md">changelog</a>)
    </div>
    <footer class="bar">
      <nav>
        <a href="#">top of page</a>
      </nav>
    </footer>
  </body>
</html>

